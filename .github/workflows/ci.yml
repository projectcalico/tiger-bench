name: ci

on:
  push:

env:
  GO_VERSION: 1.23.6
  REGISTRY: quay.io

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Install dependencies
        run: go mod download
      - name: Build
        run: go build -v ./...
      - name: Test
        run: go test -v ./...
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.60
  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: ${{ success() && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release-')) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set BRANCH to branch name
        run: echo "BRANCH=$(git rev-parse --abbrev-ref HEAD | sed 's/[^a-zA-Z0-9]/-/g')" >> $GITHUB_ENV
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ vars.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_TOKEN }}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push tiger-bench
        uses: docker/build-push-action@v6
        with:
          build-args: |
            GO_VERSION=${{ env.GO_VERSION }}
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/tigeradev/tiger-bench:${{ env.BRANCH }}
      - name: Build and push nginx
        uses: docker/build-push-action@v6
        with:
          build-args: |
            GO_VERSION=${{ env.GO_VERSION }}
          context: images/nginx/
          push: true
          tags: ${{ env.REGISTRY }}/tigeradev/tiger-bench-nginx:${{ env.BRANCH }}
      - name: Build and push perf
        uses: docker/build-push-action@v6
        with:
          build-args: |
            GO_VERSION=${{ env.GO_VERSION }}
          context: images/perf/
          push: true
          tags: ${{ env.REGISTRY }}/tigeradev/tiger-bench-perf:${{ env.BRANCH }}
